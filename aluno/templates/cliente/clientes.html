{% extends 'base.html' %}

{% block center %}
<h2>Lista de Clientes</h2>

<a href="{% url 'cliente_criar' %}" class="btn btn-success mb-3">Novo Cadastro</a>

<form method="get" class="form-inline mb-3">
  <input type="text" name="q" placeholder="Buscar por nome..." value="{{ q }}" class="form-control mr-2" />
  <select name="cidade" class="form-control mr-2">
    <option value="">Todas as cidades</option>
    {% for cidade in cidades %}
      <option value="{{ cidade.id }}" {% if cidade.id|stringformat:"s" == cidade_selected %}selected{% endif %}>
        {{ cidade.nome }} - {{ cidade.sigla_estado }}
      </option>
    {% endfor %}
  </select>
  <button type="submit" class="btn btn-primary">Filtrar</button>
</form>

{% if is_paginated %}
  <p>Mostrando {{ page_obj.start_index }}–{{ page_obj.end_index }} de {{ paginator.count }} itens</p>
{% else %}
  <p>Mostrando {{ page_obj|length }} de {{ paginator.count }} itens</p>
{% endif %}

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Foto</th>
      <th>Nome</th>
      <th>Email</th>
      <th>Cidade</th>
      <th>Telefone</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody>
    {% for cliente in page_obj.object_list %}
    <tr>
      <td>
        {% if cliente.foto %}
          <img src="{{ cliente.foto.url }}" alt="Foto do {{ cliente.nome }}" width="50" height="50" style="border-radius: 50%; object-fit: cover;">
        {% else %}
          <div style="width: 50px; height: 50px; background-color: #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <span style="font-size: 12px;">Sem foto</span>
          </div>
        {% endif %}
      </td>
      <td>{{ cliente.nome }}</td>
      <td>{{ cliente.email }}</td>
      <td>{{ cliente.cidade.nome }}</td>
      <td>{{ cliente.telefone }}</td>
      <td>
        {% comment %}
          Exibimos os botões apenas se:
          - o usuário for superusuário, OU
          - o cliente estiver associado ao usuário logado.
        {% endcomment %}
        {% if user.is_superuser or cliente.usuario and cliente.usuario == user %}
          <a href="{% url 'cliente_detalhar' id=cliente.id %}" class="btn btn-info btn-sm">Detalhar</a>
          <a href="{% url 'cliente_editar' id=cliente.id %}" class="btn btn-primary btn-sm">Editar</a>
          <a href="{% url 'cliente_remover' id=cliente.id %}" class="btn btn-danger btn-sm"
             onclick="return confirm('Tem certeza que deseja remover este perfil?');">Remover</a>
        {% else %}
          <span class="text-muted" style="font-size: 0.9em;">Sem permissão</span>
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="6">Nenhum resultado.</td></tr>
    {% endfor %}
  </tbody>
</table>

<div class="pagination">
  {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}" class="btn btn-secondary">Anterior</a>
  {% else %}
    <span class="btn btn-light disabled">Anterior</span>
  {% endif %}

  <span style="margin:0 10px;">Página {{ page_obj.number }} de {{ paginator.num_pages }}</span>

  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}" class="btn btn-secondary">Próxima</a>
  {% else %}
    <span class="btn btn-light disabled">Próxima</span>
  {% endif %}
</div>
{% endblock %}
